<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>云思</title>
    <style>
        body {
            background-color: #d9e9ca;
            text-align: center;
        }

	.mylist li {
		width: 280px;   /*如果显示三列 则width改为70px*/
		float: left;
        display: block;
    }

        
    </style>
     {% load static %}
 <!--   <link rel="stylesheet" type="text/css" href="{% static 'bootstrap.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'bootstrap-responsive.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'examples.css' %}"> -->
    <link rel="stylesheet" type="text/css" href="{% static 'image-picker.css' %}">
</head>
<body>
    {% load static %}
    <div>
    <img style="display:inline-block;vertical-align:top;" id='img' src="{% static imgname %}" alt="图片" width="600" height="600">
    <div style="display:inline-block;vertical-align:top;">
    <div style="height:600px;width:450px;overflow:auto;background:#EEEEEE;margin: auto;">
        <table id='Tbl'>
            <tr>
                <th>词语</th>
                <th>出现频次</th>
            </tr>
            {% for wf in word_frequency %}
            <tr>
                <td><input value='{{wf.0}}' /></td>
                <td><input value='{{wf.1}}' /></td>
                <td>
                    <input type="button" value="删除" onClick="removeRow(this)" />
                </td>
            </tr>
            {% endfor %}
        </table>
        </div>

    </div>
    </div>
    <div style="margin-top:10px">
    <button id='downloadPic' onclick="javascript:window.location.href='download/?imgname={{imgname}}'">下载图片</button>
    <button id='downloadCsv'>下载词表</button>
    <button onclick="addRow()">新增词语</button>
    <button id="send-word-frequency-to-views">重绘</button>
    <button onclick="getSelectedShape()">按所选背景图重绘</button>
    </div>
    <div>
    <div style="height:600px;width:600px;overflow:auto;margin:auto;display:inline-block;vertical-align:top">
	<div class="picker">
		<select class='image-picker' id='sel'>
			<option data-img-src="{% static '1s.png' %}" value='1.png'>  Page 1  </option>
            <option data-img-src="{% static '2s.png' %}" value='2.png'>  Page 2  </option>
            <option data-img-src="{% static '3s.jpg' %}" value='3.png'>  Page 3  </option>
            <option data-img-src="{% static '4s.jpg' %}" value='4.png'>  Page 4  </option>
            <option data-img-src="{% static '5s.jpg' %}" value='5.png'>  Page 5  </option>
            <option data-img-src="{% static '6s.jpg' %}" value='6.png'>  Page 6  </option>
            <option data-img-src="{% static '7s.jpg' %}" value='7.png'>  Page 7  </option>
            <option data-img-src="{% static '8s.jpg' %}" value='8.png'>  Page 8  </option>
            <option data-img-src="{% static '9s.jpg' %}" value='9.png'>  Page 9  </option>
            <option data-img-src="{% static '10s.png' %}" value='10.png'>  Page 10  </option>
            <option data-img-src="{% static '11s.jpg' %}" value='11.png'>  Page 11  </option>
            <option data-img-src="{% static '12s.jpg' %}" value='12.png'>  Page 12  </option>
            <option data-img-src="{% static '13s.png' %}" value='13.png'>  Page 10  </option>
            <option data-img-src="{% static '14s.png' %}" value='14.png'>  Page 11  </option>
            <option data-img-src="{% static '15s.png' %}" value='15.png'>  Page 12  </option>
            <option data-img-src="{% static '16s.jpg' %}" value='16.png'>  Page 10  </option>
            <option data-img-src="{% static '17s.png' %}" value='17.png'>  Page 11  </option>
            <option data-img-src="{% static '18s.png' %}" value='18.png'>  Page 12  </option>
            <option data-img-src="{% static '19s.jpg' %}" value='19.png'>  Page 10  </option>
            <option data-img-src="{% static '20s.jpg' %}" value='20.png'>  Page 11  </option>
            <option data-img-src="{% static '21s.jpg' %}" value='21.png'>  Page 12  </option>
            <option data-img-src="{% static '22s.png' %}" value='22.png'>  Page 10  </option>
            <option data-img-src="{% static '23s.jpg' %}" value='23.png'>  Page 11  </option>
			<option data-img-src="{% static '24s.png' %}" value='24.png'>  Page 12  </option>
		</select>
    </div>
    </div>
    <div class="mylist" style="height:600px;width:600px;overflow:auto;margin:auto;display:inline-block;vertical-align:top">
    <ul>
       <li><label>文字颜色</label></li>
        <li><input id='wordcolor' type="color" value="#00bfff"/></li>
       <li><label >背景颜色</label></li>
       <li><input id='bgcolor' type="color" value="#FFFFFF"/></li>
    </ul>
    </div>
</div>

    <script type="text/javascript" src="{% static 'jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'jquery.masonry.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'image-picker.min.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function(){
        
            $("select.image-picker").imagepicker({
                hide_select:false
            });
            
            $("select.image-picker.show-labels").imagepicker({
                hide_select:false, 
                show_label:true
            });
            
            $("select.image-picker.limit_callback").imagepicker({
                limit_reached:function(){
                    alert('We are full!')
                },hide_select:false
            });
            
            //瀑布流布局
            var container = $("select.image-picker.masonry").next("ul.thumbnails");
            
            container.imagesLoaded(function(){ 
                container.masonry({ 
                    itemSelector:"li"
                }); 
            });
            
        });
        </script>
    <script type="text/javascript">
        function removeRow(inputobj) {
            if (inputobj == null) return;
            var parentTD = inputobj.parentNode;
            var parentTR = parentTD.parentNode;
            var parentTBODY = parentTR.parentNode;
            parentTBODY.removeChild(parentTR);
        }

        
        function addRow() {

            //添加行
            var newTr = Tbl.insertRow(1);

            //添加列
            var newTd0 = newTr.insertCell();
            var newTd1 = newTr.insertCell();
            var newTd2 = newTr.insertCell();

            //设置列内容和属性
            newTd0.innerHTML = "<td><input value='' /></td>";
            newTd1.innerHTML = "<td><input value='' /></td>";
            newTd2.innerHTML = '<input type="button" value="删除" onClick="removeRow(this)" />';
        }


        function download_csv(csv, filename) {
            var csvFile;
            var downloadLink;

            // CSV FILE
            csvFile = new Blob([csv], { type: "text/csv" });

            // Download link
            downloadLink = document.createElement("a");

            // File name
            downloadLink.download = filename;

            // We have to create a link to the file
            downloadLink.href = window.URL.createObjectURL(csvFile);

            // Make sure that the link is not displayed
            downloadLink.style.display = "none";

            // Add the link to your DOM
            document.body.appendChild(downloadLink);

            // Lanzamos
            downloadLink.click();
        }

        function export_table_to_csv(html, filename) {
            var csv = [];
            var rows = document.querySelectorAll("table tr");

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll("td, th");

                for (var j = 0; j < 2; j++)
                    row.push(cols[j].childNodes[0].value);

                csv.push(row.join(","));
            }

            // Download CSV
            download_csv(csv.join("\n"), filename);
        }

        document.getElementById('downloadCsv').addEventListener("click", function () {
            var html = document.querySelector("table").outerHTML;
            export_table_to_csv(html, "table.csv");
        });


        $(document).ready(function () {
            $("#send-word-frequency-to-views").click(function () {
                var csv = [];
                var rows = document.querySelectorAll("table tr");

                for (var i = 0; i < rows.length; i++) {
                    var row = [], cols = rows[i].querySelectorAll("td, th");

                    for (var j = 0; j < 2; j++)
                        row.push(cols[j].childNodes[0].value);

                    csv.push(row.join(","));
                }
                var myselect = document.getElementById('sel');
                var index=myselect.selectedIndex ;  
                var shapeName = myselect.options[index].value;
                var wordColor = document.getElementById('wordcolor').value;
                var bgColor = document.getElementById('bgcolor').value;
                $.ajax({
                    url: "regenerate/",
                    type: "POST",
                    dataType: "json",
                    data: {
                        word_frequency: JSON.stringify(csv),
                        shapeName:shapeName,
                        wordColor:wordColor,
                        bgColor:bgColor,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (json) {

                        var img = document.getElementById('img');
                        var new_imgname = json['imgname'];
                        var src = "{% static 'placeholder'%}"
                        src = src.replace('placeholder', new_imgname);
                        img.src = src;

                        var downloadPicButton = document.getElementById('downloadPic');
                        var onclick = "javascript:window.location.href='download/?imgname=placeholder'";
                        onclick = onclick.replace('placeholder',new_imgname);
                        downloadPicButton.setAttribute("onclick",onclick);
                    },
                    error: function (xhr, errmsg, err) {
                        alert("Could not send URL to Django. Error: " + xhr.status + ": " + xhr.responseText);
                    }
                });
            });
        });
    </script>
</body>

</html>